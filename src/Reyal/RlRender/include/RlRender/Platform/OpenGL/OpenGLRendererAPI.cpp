#include "rlrpch.h"
#include "OpenGLRendererAPI.h"

#include <RlDebug/RlAssert.h>

#include <glad/glad.h>
#include <GLFW/glfw3.h>

#include "VertexShader.h"
#include "PixelShader.h"


namespace At0::Reyal
{
	OpenGLRendererAPI::OpenGLRendererAPI()
	{
	}

	void OpenGLRendererAPI::Init(void* window)
	{

	}
	
	bool OpenGLRendererAPI::IsInitialized() const
	{
		return true;
	}
	
	static uint32_t CompileShader(uint32_t type, const char* src)
	{
		unsigned int id = glCreateShader(type);
		glShaderSource(id, 1, &src, nullptr);
		glCompileShader(id);
		return id;
	}

	static uint32_t s_Program = 0;
	static uint32_t CreateShader(const std::string_view shaderSrc, bool isVertexShader)
	{
		unsigned int program;
		if (!s_Program)
			program = glCreateProgram();
		else
			program = s_Program;
		s_Program = program;

		unsigned int s;
		if (isVertexShader)
		{
			s = CompileShader(GL_VERTEX_SHADER, shaderSrc.data());
		}
		else
		{
			s = CompileShader(GL_FRAGMENT_SHADER, shaderSrc.data());
		}
		glAttachShader(s_Program, s);

		return s;
	}

	// Relies on glfw and glad to already be initialized
	void OpenGLRendererAPI::RenderTestTriangle()
	{
		////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////// Vertices ////////////////////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////
		float vertices[6] = {
			-0.5f, -0.5f,
			 0.0f,  0.5f,
			 0.5f, -0.5f
		};

		////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////// Vertex Buffer ///////////////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////
		uint32_t VBO;
		glGenBuffers(1, &VBO);
		glBindBuffer(GL_ARRAY_BUFFER, VBO);
		glBufferData(GL_ARRAY_BUFFER, 6 * sizeof(float), vertices, GL_STATIC_DRAW);


		////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////// Link Vertex Attributes //////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////
		glEnableVertexAttribArray(0);
		glVertexAttribPointer(0, 2, GL_FLOAT, GL_FALSE, sizeof(float) * 2, 0);


		////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////// Vertex Shader ///////////////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////
		std::string vertexSrc = R"(
#version 330 core

layout(location = 0) in vec4 position;

void main()
{
	gl_Position = position;
};
		)";
		uint32_t vs = CreateShader(vertexSrc, true);

		////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////// Pixel Shader ////////////////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////
		std::string pixelSrc = R"(
#version 330 core

layout(location = 0) out vec4 color;

void main()
{
	color = vec4(1.0, 0.0, 0.0, 1.0);
};
		)";
		uint32_t fs = CreateShader(pixelSrc, false);

		glLinkProgram(s_Program);

		glValidateProgram(s_Program);

		//glDeleteShader(vs);
		//glDeleteShader(fs);
		glUseProgram(s_Program);


		////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////// Draw Call ///////////////////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////
		glDrawArrays(GL_TRIANGLES, 0, 3);
	}
	
	void OpenGLRendererAPI::EndDraw()
	{

	}
}


